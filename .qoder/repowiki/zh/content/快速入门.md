# 快速入门

<cite>
**本文档中引用的文件**   
- [README.md](file://README.md)
- [main.go](file://cmd/kratos/main.go)
- [new.go](file://cmd/kratos/internal/project/new.go)
- [run.go](file://cmd/kratos/internal/run/run.go)
- [proto.go](file://cmd/kratos/internal/proto/proto.go)
- [app.go](file://app.go)
- [helloworld.proto](file://internal/testdata/helloworld/helloworld.proto)
- [helloworld_http.pb.go](file://internal/testdata/helloworld/helloworld_http.pb.go)
- [helloworld_grpc.pb.go](file://internal/testdata/helloworld/helloworld_grpc.pb.go)
- [helloworld.pb.go](file://internal/testdata/helloworld/helloworld.pb.go)
- [go.mod](file://go.mod)
- [install.go](file://cmd/kratos/internal/base/install.go)
- [polaris.yaml](file://contrib/config/polaris/polaris.yaml)
- [buf.gen.yaml](file://cmd/protoc-gen-go-errors/buf.gen.yaml)
</cite>

## 目录
1. [环境准备](#环境准备)
2. [创建项目](#创建项目)
3. [项目结构解析](#项目结构解析)
4. [运行服务](#运行服务)
5. [Hello World API 示例](#hello-world-api-示例)
6. [常见问题排查](#常见问题排查)
7. [总结](#总结)

## 环境准备

在开始使用 Kratos 框架之前，需要先安装必要的依赖环境。Kratos 是一个基于 Go 语言的微服务治理框架，依赖 Go 环境、Protobuf 编译器和 Kratos CLI 工具。

首先确保已安装 Go 1.22 或更高版本。可以通过以下命令验证 Go 环境是否正确安装：
```shell
go version
```

接下来安装 Protobuf 编译器（protoc），这是用于编译 `.proto` 文件的工具。不同操作系统的安装方式略有不同：
- **macOS**: 使用 Homebrew 安装 `brew install protobuf`
- **Linux**: 使用包管理器如 `apt-get install protobuf-compiler`
- **Windows**: 从 GitHub 下载预编译的二进制文件并添加到系统 PATH

最后安装 Kratos CLI 工具，这是创建和管理 Kratos 项目的命令行工具：
```shell
go install github.com/go-kratos/kratos/cmd/kratos/v2@latest
```

安装完成后，可以通过 `kratos -h` 命令验证工具是否安装成功。

**Section sources**
- [README.md](file://README.md#L74)
- [install.go](file://cmd/kratos/internal/base/install.go#L10-L25)

## 创建项目

使用 Kratos CLI 工具可以快速创建一个新的微服务项目。Kratos 提供了 `kratos new` 命令来生成项目模板。

执行以下命令创建一个名为 "helloworld" 的新项目：
```shell
kratos new helloworld
```

该命令会从默认的项目模板仓库 `https://github.com/go-kratos/kratos-layout.git` 克隆项目模板，并根据指定的项目名称进行初始化。如果需要使用自定义的模板仓库，可以通过 `--repo-url` 参数指定。

项目创建完成后，进入项目目录并整理依赖：
```shell
cd helloworld
go mod tidy
```

`go mod tidy` 命令会自动下载项目所需的所有依赖包，并清理 `go.mod` 文件中未使用的依赖。

**Section sources**
- [main.go](file://cmd/kratos/main.go#L24)
- [new.go](file://cmd/kratos/internal/project/new.go#L22-L64)
- [project.go](file://cmd/kratos/internal/project/project.go#L19-L23)

## 项目结构解析

Kratos 项目遵循标准的 Go 项目结构，主要目录和文件的作用如下：

- **api/**: 存放 Protobuf 接口定义文件（`.proto`）和生成的代码
- **cmd/**: 存放应用程序的入口文件，每个服务对应一个子目录
- **internal/**: 存放项目的内部实现代码，包括业务逻辑、数据访问等
- **pkg/**: 存放可复用的公共包
- **configs/**: 存放配置文件
- **go.mod** 和 **go.sum**: Go 模块依赖管理文件

项目的核心是 `api` 目录下的 `.proto` 文件，它定义了服务的接口和数据结构。Kratos 使用 Protobuf 作为通信协议的基础，通过 `.proto` 文件可以同时生成 HTTP 和 gRPC 的接口代码。

例如，在 `internal/testdata/helloworld/helloworld.proto` 文件中定义了一个简单的 Greeter 服务：
```protobuf
service Greeter {
  rpc SayHello (HelloRequest) returns (HelloReply) {
    option (google.api.http) = {
      get: "/helloworld/{name}",
    };
  }
}
```

这个定义同时声明了 gRPC 接口和 HTTP 映射关系，使得同一个接口可以通过多种协议访问。

**Section sources**
- [helloworld.proto](file://internal/testdata/helloworld/helloworld.proto#L1-L29)
- [README.md](file://README.md#L27-L28)

## 运行服务

创建项目后，可以使用 `kratos run` 命令直接运行服务，无需手动编译。

在项目根目录执行：
```shell
kratos run
```

该命令会自动查找 `cmd` 目录下的可执行文件并运行。如果项目中有多个服务，会提示选择要运行的服务。

服务启动后，默认会在 8000 端口监听。可以通过浏览器访问 `http://localhost:8000/helloworld/kratos` 来验证服务是否正常运行。

`kratos run` 命令的实现位于 `cmd/kratos/internal/run/run.go` 文件中，它使用 `exec.Command` 执行 Go 运行命令，并处理标准输出和错误输出。

**Section sources**
- [run.go](file://cmd/kratos/internal/run/run.go#L28-L79)
- [main.go](file://cmd/kratos/main.go#L30)

## Hello World API 示例

让我们通过一个完整的 "Hello World" 示例来演示从接口定义到业务实现的完整流程。

首先，在 `api/helloworld/v1/greeter.proto` 文件中定义服务接口：
```protobuf
syntax = "proto3";

package helloworld.v1;

option go_package = "helloworld/api/helloworld/v1";

service Greeter {
  rpc SayHello (HelloRequest) returns (HelloReply) {
    option (google.api.http) = {
      get: "/helloworld/v1/hello/{name}",
    };
  }
}

message HelloRequest {
  string name = 1;
}

message HelloReply {
  string message = 1;
}
```

然后使用 `kratos proto add` 命令生成接口代码：
```shell
kratos proto add api/helloworld/v1/greeter.proto
```

接下来实现业务逻辑。在 `internal/service/greeter.go` 文件中：
```go
func (s *GreeterService) SayHello(ctx context.Context, req *v1.HelloRequest) (*v1.HelloReply, error) {
    return &v1.HelloReply{Message: "Hello " + req.Name}, nil
}
```

最后启动服务并测试：
```shell
kratos run
curl http://localhost:8000/helloworld/v1/hello/World
```

**Section sources**
- [helloworld.proto](file://internal/testdata/helloworld/helloworld.proto#L1-L29)
- [helloworld_http.pb.go](file://internal/testdata/helloworld/helloworld_http.pb.go#L26-L29)
- [app.go](file://app.go#L39-L60)

## 常见问题排查

在使用 Kratos 框架时可能会遇到一些常见问题，以下是解决方案：

**环境变量配置问题**：如果遇到依赖下载失败，可以设置 GOPROXY 环境变量：
```shell
export GOPROXY=https://goproxy.io,direct
```

**端口冲突**：如果 8000 端口已被占用，可以在启动时指定其他端口：
```shell
kratos run -conf ./configs --http.port=8080
```

**依赖下载失败**：确保 Go 环境配置正确，可以尝试清除模块缓存后重新下载：
```shell
go clean -modcache
go mod tidy
```

**Protobuf 编译错误**：确保 protoc 和相关插件已正确安装，版本兼容。

**Section sources**
- [README.md](file://README.md#L73)
- [polaris.yaml](file://contrib/config/polaris/polaris.yaml#L1-L9)
- [buf.gen.yaml](file://cmd/protoc-gen-go-errors/buf.gen.yaml#L1-L7)

## 总结

通过以上步骤，我们完成了 Kratos 框架的快速入门。从环境准备、项目创建、结构解析到服务运行和 API 示例，展示了 Kratos 作为微服务框架的核心功能。

Kratos 通过 Protobuf 定义接口，实现了 HTTP 和 gRPC 的统一，简化了微服务开发。其丰富的中间件支持和灵活的配置系统，使得开发者可以专注于业务逻辑的实现。

对于完全没有框架经验的开发者，建议按照本文档的步骤逐一操作，即可在 5 分钟内完成首次体验。

**Section sources**
- [README.md](file://README.md#L21-L38)
- [app.go](file://app.go#L83-L151)