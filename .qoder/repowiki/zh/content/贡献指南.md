# 贡献指南

<cite>
**本文档中引用的文件**  
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [README.md](file://README.md)
- [go.mod](file://go.mod)
- [.golangci.yml](file://.golangci.yml)
- [Makefile](file://Makefile)
- [hack/tools.sh](file://hack/tools.sh)
- [codecov.yml](file://codecov.yml)
- [SECURITY.md](file://SECURITY.md)
- [CODE_OF_CONDUCT.md](file://CODE_OF_CONDUCT.md)
- [cmd/kratos/internal/project/project_test.go](file://cmd/kratos/internal/project/project_test.go)
- [cmd/kratos/internal/base/mod_test.go](file://cmd/kratos/internal/base/mod_test.go)
- [config/config_test.go](file://config/config_test.go)
- [middleware/logging/logging_test.go](file://middleware/logging/logging_test.go)
- [transport/http/server_test.go](file://transport/http/server_test.go)
</cite>

## 目录
1. [开发环境搭建](#开发环境搭建)
2. [代码规范](#代码规范)
3. [测试要求](#测试要求)
4. [提交流程](#提交流程)
5. [调试技巧与性能测试](#调试技巧与性能测试)
6. [安全漏洞报告流程](#安全漏洞报告流程)
7. [社区行为准则](#社区行为准则)

## 开发环境搭建

本项目基于 Go 语言开发，开发者需要配置相应的开发环境以确保代码的一致性和可维护性。

### Go 版本要求
根据项目根目录下的 `go.mod` 文件，本项目要求使用 **Go 1.22** 或更高版本。请确保您的 Go 环境满足此版本要求。

### 依赖安装
项目使用 Go Modules 进行依赖管理。您可以通过以下命令安装项目所需的所有依赖：

```bash
go mod tidy
```

该命令会自动下载并同步 `go.mod` 中声明的所有依赖项。

### 工具链配置
项目依赖多个代码生成和验证工具，这些工具可通过 Makefile 自动安装。执行以下命令可安装所有必要的工具：

```bash
make install
```

此命令将构建并安装以下核心工具：
- `kratos`: 项目脚手架工具，用于创建新项目和服务
- `protoc-gen-go-errors`: 错误码生成插件
- `protoc-gen-go-http`: HTTP 协议生成插件

此外，还需手动安装以下 Protobuf 相关工具：
```bash
go get google.golang.org/protobuf/cmd/protoc-gen-go
go get google.golang.org/grpc/cmd/protoc-gen-go-grpc
go get github.com/envoyproxy/protoc-gen-validate
```

### 开发工具配置
项目使用 `golangci-lint` 作为统一的代码质量检查工具。相关配置位于 `.golangci.yml` 文件中，启用了包括 `errcheck`、`gocyclo`、`govet`、`staticcheck` 等在内的多个 linter。您可以通过以下命令运行代码检查：

```bash
make lint
```

格式化工具包括 `gofmt`、`gofumpt` 和 `goimports`，其中 `goimports` 配置了本地前缀 `github.com/go-kratos`，确保导入路径的正确排序。

**Section sources**
- [go.mod](file://go.mod#L1-L49)
- [.golangci.yml](file://.golangci.yml#L1-L72)
- [Makefile](file://Makefile#L1-L101)
- [hack/tools.sh](file://hack/tools.sh#L1-L126)

## 代码规范

为保持代码风格的一致性，项目制定了严格的代码规范，涵盖命名约定、注释要求和错误处理模式。

### 命名约定
- **包名**：使用简洁的小写单词，避免使用下划线或驼峰命名
- **变量与函数**：采用驼峰命名法（camelCase），首字母小写表示包内私有，首字母大写表示导出
- **常量**：采用全大写加下划线分隔（如 `MAX_RETRY_COUNT`）
- **接口**：单方法接口以 `-er` 结尾（如 `Reader`、`Writer`），多方法接口应具有描述性名称

### 注释要求
- 所有导出的类型、函数、变量和常量必须包含 GoDoc 注释
- 注释应清晰描述功能、参数、返回值及可能的错误情况
- 复杂逻辑或算法应添加内联注释解释其实现原理
- 避免无意义的注释，如 `// 设置值` 这类冗余说明

### 错误处理模式
项目采用统一的错误处理机制，位于 `errors` 包中。关键原则包括：
- 使用 `errors.New` 或 `fmt.Errorf` 创建新错误
- 通过 `errors.Wrap` 添加上下文信息，保留原始错误堆栈
- 自定义错误类型应实现 `error` 接口，并提供 `Unwrap` 方法支持错误链
- 在中间件和传输层中，错误应被标准化为包含错误码、消息和元数据的结构化错误

**Section sources**
- [errors/errors.go](file://errors/errors.go)
- [errors/types.go](file://errors/types.go)
- [errors/wrap.go](file://errors/wrap.go)

## 测试要求

测试是保证代码质量的关键环节，项目对单元测试和集成测试有明确要求。

### 单元测试
- 所有核心功能模块必须提供单元测试
- 测试文件命名以 `_test.go` 结尾，与被测文件位于同一包内
- 使用标准库 `testing` 包进行断言，避免引入第三方断言库
- 测试应覆盖正常路径、边界条件和错误路径

例如，在 `config` 包中，`config_test.go` 文件通过模拟 JSON 配置源来测试配置加载和解析功能，验证了嵌套结构、数组和类型转换的正确性。

### 集成测试
- 对于涉及多个组件交互的功能，需编写集成测试
- 使用 `httptest`、`testpb` 等工具模拟 HTTP/gRPC 服务进行端到端测试
- 测试应验证中间件链、传输层和业务逻辑的协同工作

在 `transport/http/server_test.go` 中，`TestServer` 函数启动一个 HTTP 服务器，通过客户端请求验证路由、处理器和错误编码器的集成行为。

### 测试覆盖率目标
项目使用 Codecov 进行覆盖率统计，配置文件 `codecov.yml` 明确排除了示例代码和生成代码（`.pb.go` 文件）。核心目标是：
- 核心组件的测试覆盖率应达到 **80% 以上**
- 关键路径（如错误处理、边界检查）必须 100% 覆盖
- 新增代码必须附带测试，否则 CI 将拒绝合并

### 运行测试套件
使用以下命令运行完整测试套件：

```bash
make test
```

该命令会并行执行所有模块的测试，并启用 `-race` 检测数据竞争。若需生成覆盖率报告，使用：

```bash
make test-coverage
```

**Section sources**
- [config/config_test.go](file://config/config_test.go#L1-L189)
- [middleware/logging/logging_test.go](file://middleware/logging/logging_test.go#L1-L236)
- [transport/http/server_test.go](file://transport/http/server_test.go#L1-L488)
- [cmd/kratos/internal/project/project_test.go](file://cmd/kratos/internal/project/project_test.go#L1-L145)
- [codecov.yml](file://codecov.yml#L1-L4)

## 提交流程

为确保代码质量和协作效率，项目遵循标准化的提交流程。

### 分支策略
- 所有开发基于 `main` 分支进行
- 功能开发应在本地创建特性分支，命名格式为 `feature/功能描述`（如 `feature/user-auth`）
- 修复 bug 使用 `fix/问题描述` 命名分支
- 完成开发后，推送分支并创建 Pull Request

### 提交信息格式
项目采用 [Conventional Commits](https://www.conventionalcommits.org/) 规范，提交信息格式如下：

```
<类型>[可选范围]: <描述>

[可选正文]

[可选脚注]
```

**类型** 包括：
- `fix`: 修复 bug
- `feat`: 新功能
- `deps`: 依赖变更
- `break`: 不兼容的变更
- `docs`: 文档变更
- `refactor`: 重构代码
- `style`: 格式调整
- `test`: 测试相关
- `chore`: 日常维护
- `ci`: CI 配置变更

**范围** 可选值包括 `transport`、`middleware`、`config`、`cmd` 等。

### Pull Request 审查流程
1. 创建 PR 时，必须关联相关 issue（如有）
2. CI 系统将自动运行测试、代码检查和覆盖率分析
3. 至少一名核心维护者需审查代码，关注点包括：
   - 功能正确性
   - 代码风格一致性
   - 测试覆盖率
   - 文档完整性
4. 根据反馈修改后，再次触发 CI 检查
5. 所有检查通过且获得批准后，由维护者合并到 `main` 分支

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L122)

## 调试技巧与性能测试

### 调试技巧
- 使用 `log` 包进行结构化日志输出，便于追踪请求链路
- 在中间件中启用 `logging` 和 `tracing` 以观察请求处理流程
- 利用 `pprof` 工具分析 CPU 和内存使用情况
- 通过 `transport/http/status` 检查服务健康状态

### 性能测试
项目提供基准测试支持，可使用 `go test -bench` 进行性能评估。例如，在 `transport/http/server_test.go` 中包含 `BenchmarkServer` 函数，用于测量 HTTP 服务器的吞吐量和延迟。

建议在优化关键路径（如编解码、路由匹配）时编写基准测试，确保性能改进可量化。

**Section sources**
- [transport/http/server_test.go](file://transport/http/server_test.go#L249-L285)
- [transport/http/pprof/pprof.go](file://transport/http/pprof/pprof.go)

## 安全漏洞报告流程

发现安全漏洞时，请勿通过公开 issue 报告，以免暴露潜在风险。

### 报告方式
通过电子邮件将漏洞详情发送至指定安全团队：
- 邮箱：go-kratos@googlegroups.com
- 抄送：tonybase

### 报告内容
请包含以下信息：
- 漏洞描述及影响范围
- 复现步骤
- 潜在危害等级
- 建议的修复方案

### 响应承诺
安全团队承诺：
- 在 48 小时内确认收到报告
- 7 天内提供初步评估
- 及时沟通修复进度
- 漏洞修复后公开致谢报告者

**Section sources**
- [SECURITY.md](file://SECURITY.md#L1-L20)
- [README.md](file://README.md#L87-L89)

## 社区行为准则

为营造健康、包容的开源社区氛围，所有参与者必须遵守《贡献者公约行为准则》。

### 我们的承诺
我们承诺为所有人提供一个无骚扰的参与环境，尊重不同年龄、性别、种族、宗教、性取向等背景的成员。

### 可接受行为
- 对他人展现同理心和善意
- 尊重不同观点和经验
- 优雅地给予和接受建设性反馈
- 为错误承担责任并道歉
- 关注社区整体利益

### 不可接受行为
- 使用性化语言或图像
- 人身攻击、贬损性评论
- 公开或私下骚扰
- 未经许可发布他人隐私信息
- 任何在专业场合下不适当的行为

### 执行机制
社区领导者有权对违规行为采取纠正措施，包括但不限于：
1. **纠正**：私下发出口头或书面警告
2. **警告**：限制一段时间内的互动
3. **临时封禁**：暂时禁止参与社区活动
4. **永久封禁**：永久禁止参与社区

违规行为可向社区负责人举报：iammao@vip.qq.com

**Section sources**
- [CODE_OF_CONDUCT.md](file://CODE_OF_CONDUCT.md#L1-L129)