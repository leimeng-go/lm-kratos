# 贡献模块

<cite>
**本文档中引用的文件**  
- [registry.go](file://registry/registry.go)
- [config.go](file://config/config.go)
- [log.go](file://log/log.go)
- [validate.go](file://contrib/middleware/validate/validate.go)
- [registry.go](file://contrib/registry/consul/registry.go)
- [registry.go](file://contrib/registry/etcd/registry.go)
- [registry.go](file://contrib/registry/nacos/registry.go)
- [apollo.go](file://contrib/config/apollo/apollo.go)
- [config.go](file://contrib/config/kubernetes/config.go)
- [config.go](file://contrib/config/nacos/config.go)
- [zap.go](file://contrib/log/zap/zap.go)
- [fluent.go](file://contrib/log/fluent/fluent.go)
</cite>

## 目录
1. [简介](#简介)
2. [设计理念](#设计理念)
3. [注册中心系列](#注册中心系列)
4. [配置中心系列](#配置中心系列)
5. [日志系列](#日志系列)
6. [中间件系列](#中间件系列)
7. [自定义贡献模块开发指南](#自定义贡献模块开发指南)

## 简介
Kratos框架的贡献模块（contrib）系统提供了一套插件化扩展机制，允许开发者将非核心但常用的功能实现以独立模块的形式集成到框架中。这种设计保持了核心框架的简洁性，同时提供了强大的可扩展能力。本文档详细介绍了贡献模块的设计理念、主要分类、集成方法以及自定义开发指南。

## 设计理念
Kratos框架通过`contrib`目录实现了插件化扩展机制，其核心设计理念是将非核心但常用的功能实现分离到独立的模块中。这种设计有以下几个优势：

1. **保持核心简洁**：核心框架只包含最基本的功能，避免了功能膨胀。
2. **按需引入**：开发者可以根据项目需求选择性地引入所需的贡献模块，减少不必要的依赖。
3. **易于维护**：每个贡献模块都是独立的，可以单独进行版本管理和维护。
4. **社区驱动**：开放的插件机制鼓励社区贡献，丰富了框架的生态系统。

贡献模块通过实现框架定义的接口规范来提供功能扩展，确保了插件与核心框架的兼容性和一致性。

**Section sources**
- [registry.go](file://registry/registry.go)
- [config.go](file://config/config.go)
- [log.go](file://log/log.go)

## 注册中心系列
注册中心系列贡献模块实现了服务注册与发现功能，支持多种主流的服务注册中心。这些模块实现了`registry.Registrar`和`registry.Discovery`接口，提供了统一的服务注册、注销和发现能力。

### 支持的注册中心
- **etcd**：基于etcd的注册中心实现
- **consul**：基于Consul的注册中心实现
- **nacos**：基于Nacos的注册中心实现
- **kubernetes**：基于Kubernetes的注册中心实现
- **eureka**：基于Eureka的注册中心实现
- **zookeeper**：基于ZooKeeper的注册中心实现

### 接口规范
注册中心模块需要实现以下接口：

```go
type Registrar interface {
    Register(ctx context.Context, service *ServiceInstance) error
    Deregister(ctx context.Context, service *ServiceInstance) error
}

type Discovery interface {
    GetService(ctx context.Context, serviceName string) ([]*ServiceInstance, error)
    Watch(ctx context.Context, serviceName string) (Watcher, error)
}
```

### 集成步骤
1. 添加依赖：
```bash
go get github.com/go-kratos/kratos/v2/contrib/registry/etcd
```

2. 在代码中使用：
```go
import "github.com/go-kratos/kratos/v2/contrib/registry/etcd"

// 创建etcd客户端
client, err := clientv3.New(clientv3.Config{
    Endpoints: []string{"localhost:2379"},
})
if err != nil {
    log.Fatal(err)
}

// 创建注册中心
r := etcd.New(client)
```

**Section sources**
- [registry.go](file://registry/registry.go)
- [registry.go](file://contrib/registry/consul/registry.go)
- [registry.go](file://contrib/registry/etcd/registry.go)
- [registry.go](file://contrib/registry/nacos/registry.go)

## 配置中心系列
配置中心系列贡献模块提供了动态配置管理功能，支持从多种配置中心获取和监听配置变更。这些模块实现了`config.Source`接口，提供了统一的配置加载和监听能力。

### 支持的配置中心
- **apollo**：基于Apollo的配置中心实现
- **kubernetes**：基于Kubernetes ConfigMap的配置中心实现
- **nacos**：基于Nacos的配置中心实现
- **consul**：基于Consul的配置中心实现
- **etcd**：基于etcd的配置中心实现

### 接口规范
配置中心模块需要实现以下接口：

```go
type Source interface {
    Load() ([]*KeyValue, error)
    Watch() (Watcher, error)
}

type Watcher interface {
    Next() ([]*KeyValue, error)
    Stop() error
}
```

### 集成步骤
1. 添加依赖：
```bash
go get github.com/go-kratos/kratos/v2/contrib/config/apollo
```

2. 在代码中使用：
```go
import "github.com/go-kratos/kratos/v2/contrib/config/apollo"

// 创建Apollo配置源
source := apollo.NewSource(
    apollo.WithEndpoint("http://apollo-config-server:8080"),
    apollo.WithAppID("myapp"),
    apollo.WithNamespace("application"),
)
```

### 配置示例
```go
// Kubernetes配置示例
source := kubernetes.NewSource(
    kubernetes.Namespace("default"),
    kubernetes.LabelSelector("app=myapp"),
)

// Nacos配置示例
source := nacos.NewConfigSource(client,
    nacos.WithGroup("DEFAULT_GROUP"),
    nacos.WithDataID("myapp.yaml"),
)
```

**Section sources**
- [config.go](file://config/config.go)
- [apollo.go](file://contrib/config/apollo/apollo.go)
- [config.go](file://contrib/config/kubernetes/config.go)
- [config.go](file://contrib/config/nacos/config.go)

## 日志系列
日志系列贡献模块提供了与不同日志后端的集成能力，支持多种流行的日志框架。这些模块实现了`log.Logger`接口，提供了统一的日志输出能力。

### 支持的日志后端
- **zap**：与Uber的Zap日志库集成
- **fluent**：与Fluentd日志系统集成
- **logrus**：与Logrus日志库集成
- **zerolog**：与Zerolog日志库集成
- **aliyun**：与阿里云日志服务集成
- **tencent**：与腾讯云日志服务集成

### 接口规范
日志模块需要实现以下接口：

```go
type Logger interface {
    Log(level Level, keyvals ...any) error
    Sync() error
    Close() error
}
```

### 集成步骤
1. 添加依赖：
```bash
go get github.com/go-kratos/kratos/v2/contrib/log/zap
```

2. 在代码中使用：
```go
import "github.com/go-kratos/kratos/v2/contrib/log/zap"

// 创建Zap日志记录器
z, _ := zap.NewProduction()
logger := zap.NewLogger(z)
```

### 配置示例
```go
// Fluentd配置示例
logger, err := fluent.NewLogger("tcp://localhost:24224",
    fluent.WithTagPrefix("myapp"),
    fluent.WithAsync(true),
)

// Zap配置示例
logger := zap.NewLogger(zapLogger,
    zap.WithMessageKey("msg"),
)
```

**Section sources**
- [log.go](file://log/log.go)
- [zap.go](file://contrib/log/zap/zap.go)
- [fluent.go](file://contrib/log/fluent/fluent.go)

## 中间件系列
中间件系列贡献模块提供了额外的功能中间件，可以在请求处理链中插入特定的处理逻辑。这些模块实现了`middleware.Middleware`接口，提供了统一的中间件能力。

### 支持的中间件
- **validate**：请求参数验证中间件
- **jwt**：JWT认证中间件
- **circuitbreaker**：熔断器中间件
- **ratelimit**：限流中间件
- **tracing**：分布式追踪中间件
- **metrics**：指标收集中间件

### 接口规范
中间件模块需要实现以下接口：

```go
type Middleware func(Handler) Handler
```

### 集成步骤
1. 添加依赖：
```bash
go get github.com/go-kratos/kratos/v2/contrib/middleware/validate
```

2. 在代码中使用：
```go
import "github.com/go-kratos/kratos/v2/contrib/middleware/validate"

// 添加验证中间件
app := kratos.New(
    kratos.Server(
        // HTTP和gRPC服务器
    ),
    kratos.Middleware(
        validate.ProtoValidate(),
    ),
)
```

### 配置示例
```go
// Validate中间件示例
middleware := validate.ProtoValidate()

// JWT中间件示例
middleware := jwt.Server(
    jwt.WithSigningMethod(jwt.HS256),
    jwt.WithSigningKey([]byte("secret")),
)
```

**Section sources**
- [validate.go](file://contrib/middleware/validate/validate.go)

## 自定义贡献模块开发指南
开发自定义贡献模块需要遵循框架的接口规范和设计模式。以下是开发自定义贡献模块的详细指南。

### 开发步骤
1. **确定模块类型**：根据功能需求确定模块属于注册中心、配置中心、日志还是中间件等类别。

2. **实现接口**：根据模块类型实现相应的接口规范。

3. **遵循命名规范**：模块命名应清晰反映其功能，如`contrib/registry/my-registry`。

4. **提供配置选项**：通过Option模式提供灵活的配置能力。

5. **编写测试**：为模块编写完整的单元测试和集成测试。

### 代码结构
自定义贡献模块应遵循以下目录结构：
```
contrib/
└── category/
    └── module-name/
        ├── module-name.go
        ├── module-name_test.go
        ├── go.mod
        ├── go.sum
        └── README.md
```

### 最佳实践
1. **接口隔离**：确保模块只暴露必要的接口，保持API的简洁性。
2. **错误处理**：提供清晰的错误信息，便于调试和问题定位。
3. **文档完善**：在README中提供详细的使用说明和配置示例。
4. **性能考虑**：优化关键路径的性能，避免成为系统瓶颈。
5. **兼容性**：确保模块与框架的各个版本保持兼容。

通过遵循这些指南，开发者可以创建高质量的贡献模块，为Kratos框架生态系统做出贡献。

**Section sources**
- [registry.go](file://registry/registry.go)
- [config.go](file://config/config.go)
- [log.go](file://log/log.go)